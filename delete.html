<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous">

    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f4f4f4;
        }

        #searchBar {
            margin-bottom: 20px;
            width: 100%;
            padding: 8px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- Search Bar -->
        <div class="mb-3">
            <input
                type="text"
                id="searchBar"
                class="form-control"
                placeholder="Search by First Name or Last Name..."
                oninput="filterTable()"
            />
        </div>
    
        <!-- User Table -->
        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">No.</th>
                        <th scope="col">First Name</th>
                        <th scope="col">Middle Name</th>
                        <th scope="col">Last Name</th>
                        <th scope="col">Address</th>
                        <th scope="col">Birthday</th>
                        <th scope="col">Contact</th>
                        <th scope="col">Email</th>
                        <th scope="col">Occupation</th>
                        <th scope="col">Loan Amount</th>
                        <th scope="col">Fingerprint ID</th>
                        <th scope="col">Proof of Billing</th>
                        <th scope="col">QR Code</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <!-- User data will be dynamically inserted here -->
                </tbody>
            </table>
        </div>
    
        <!-- Pagination Controls -->
        <nav>
            <ul class="pagination justify-content-center" id="pagination">
                <!-- Pagination buttons will be dynamically generated here -->
            </ul>
        </nav>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCdzQP6n7gw8T82h2Qg-cLfnLbEqJ4WONg",
            authDomain: "caps-62ee2.firebaseapp.com",
            databaseURL: "https://caps-62ee2-default-rtdb.firebaseio.com",
            projectId: "caps-62ee2",
            storageBucket: "caps-62ee2.appspot.com",
            messagingSenderId: "407248916382",
            appId: "1:407248916382:web:104a66db2e652789e2d08f",
            measurementId: "G-2Y9GYDHFVM"
        };
    
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    
        let usersData = [];
        let filteredUsers = [];
        let currentPage = 1;
        const rowsPerPage = 10;
    
        // Fetch users data from Firebase
        function fetchUsers() {
            const usersRef = database.ref("users");
    
            usersRef.once("value").then(snapshot => {
                usersData = [];
                snapshot.forEach(childSnapshot => {
                    const user = childSnapshot.val();
                    user.userId = childSnapshot.key;
                    usersData.push(user);
                });
                filteredUsers = [...usersData];
                renderTable(filteredUsers);
                setupPagination(filteredUsers);
            }).catch(error => {
                console.error("Error fetching users data:", error);
            });
        }
    
        // Render table with user data
        function renderTable(data) {
            const userTableBody = document.getElementById("userTableBody");
            userTableBody.innerHTML = "";
    
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const paginatedData = data.slice(start, end);
    
            paginatedData.forEach((item, index) => {
                const row = `
                    <tr>
                        <th scope="row">${start + index + 1}</th>
                        <td>${item.firstName || ""}</td>
                        <td>${item.middleName || ""}</td>
                        <td>${item.lastName || ""}</td>
                        <td>${item.address || ""}</td>
                        <td>${item.birthday || ""}</td>
                        <td>${item.contact || ""}</td>
                        <td>${item.email || ""}</td>
                        <td>${item.occupation || ""}</td>
                        <td>${item.loanAmount || ""}</td>
                        <td>${item.fingerprintId || ""}</td>
                        <td>
                            <a href="${item.proofUrl}" target="_blank" class="btn btn-sm btn-info">View Proof</a>
                        </td>
                        <td>
                            <a href="${item.qrCodeURL}" target="_blank" class="btn btn-sm btn-success">View QR Code</a>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('${item.userId}')">Delete</button>
                        </td>
                    </tr>
                `;
                userTableBody.innerHTML += row;
            });
        }
    
        // Delete user from Firebase
        function deleteUser(userId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "This action will permanently delete the user.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, delete it!',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    const userRef = database.ref("users/" + userId);
                    userRef.remove()
                        .then(() => {
                            Swal.fire('Deleted!', 'User has been deleted.', 'success');
                            usersData = usersData.filter(user => user.userId !== userId);
                            filteredUsers = filteredUsers.filter(user => user.userId !== userId);
                            renderTable(filteredUsers);
                            setupPagination(filteredUsers);
                        })
                        .catch(error => {
                            Swal.fire('Error!', error.message, 'error');
                        });
                }
            });
        }
    
        // Search bar functionality
        function filterTable() {
            const searchBar = document.getElementById("searchBar");
            const query = searchBar.value.toLowerCase();
    
            filteredUsers = usersData.filter(user => {
                return (user.firstName && user.firstName.toLowerCase().includes(query)) ||
                       (user.lastName && user.lastName.toLowerCase().includes(query));
            });
    
            currentPage = 1; // Reset to the first page after filtering
            renderTable(filteredUsers);
            setupPagination(filteredUsers);
        }
    
        // Setup pagination controls
        function setupPagination(data) {
            const pagination = document.getElementById("pagination");
            pagination.innerHTML = "";
    
            const totalPages = Math.ceil(data.length / rowsPerPage);
    
            for (let i = 1; i <= totalPages; i++) {
                const pageItem = `
                    <li class="page-item ${i === currentPage ? "active" : ""}">
                        <a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>
                    </li>
                `;
                pagination.innerHTML += pageItem;
            }
        }
    
        // Go to a specific page
        function goToPage(page) {
            currentPage = page;
            renderTable(filteredUsers);
            setupPagination(filteredUsers);
        }
    
        // Fetch users data on page load
        document.addEventListener("DOMContentLoaded", fetchUsers);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+BsDpT4cJp4J0uKfUJcH49+8smXKp" crossorigin="anonymous"></script>

</body>
</html>
